name: Update Counter Widget

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 mins
  workflow_dispatch:

jobs:
  update-counter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Fetch counter stats
        run: |
          curl -s https://api.counterapi.dev/v2/maheshwar-anups-team-2363/first-counter-2363/stats \
            -H "Authorization: Bearer ${{ secrets.COUNTER_API_KEY }}" \
            -o stats.json

      - name: Generate SVG badge
        run: |
          COUNT=$(jq '.data.up_count' stats.json)

          cat <<EOF > counter.svg
          <svg xmlns="http://www.w3.org/2000/svg" width="160" height="40">
            <rect width="160" height="40" rx="8" fill="#0d1117"/>
            <text x="10" y="26" fill="#8b949e" font-size="14">Visitors</text>
            <text x="120" y="26" fill="#58a6ff" font-size="16" font-weight="bold">${COUNT}</text>
          </svg>
          EOF
      - name: Commit and push badge if changed
        env:
          COMMIT_MESSAGE: "Updated THM profile badge"
        run: |
          git add counter.svg || true
  
          # If there are no staged changes, exit successfully
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "$COMMIT_MESSAGE"

          # Push current HEAD back to the branch that triggered the workflow
          git push origin "HEAD:${{ github.ref_name }}"
