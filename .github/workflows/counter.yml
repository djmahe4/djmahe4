name: Update Counter Widget

on:
  schedule:
    - cron: "*/30 * * * *"   # every 30 mins
  workflow_dispatch:

permissions:
  contents: write   # REQUIRED to push commits

jobs:
  update-counter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch counter stats
        run: |
          curl -s https://api.counterapi.dev/v2/maheshwar-anups-team-2363/first-counter-2363 \
            -H "Authorization: Bearer ${{ secrets.COUNTER_API_KEY }}" \
            -o stats.json

      - name: Generate SVG badge
        run: |
          COUNT=$(jq -r '.data.up_count' stats.json)

          cat <<EOF > counter.svg
          <svg xmlns="http://www.w3.org/2000/svg" width="160" height="40">
            <rect width="160" height="40" rx="8" fill="#0d1117"/>
            <text x="10" y="26" fill="#8b949e" font-size="14">Visitors</text>
            <text x="120" y="26" fill="#58a6ff" font-size="16" font-weight="bold">${COUNT}</text>
          </svg>
          EOF

      - name: Commit and push badge if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          git add counter.svg
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update counter badge"
          
          # Pull latest changes to avoid non-fast-forward errors
          git pull --rebase origin ${{ github.ref_name }}
          
          # Corrected push syntax
          git push origin ${{ github.ref_name }}

